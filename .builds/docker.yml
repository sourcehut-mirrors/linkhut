image: alpine/edge
packages:
  - docker
  - docker-cli-compose
secrets:
  -  dafdc7fa-451e-44cb-aa67-339ae7ca2e87 # docker registry credentials
environment:
  DOCKER_REGISTRY: docker.io
  DOCKER_REPOSITORY: matiaslb/linkhut
  DOCKER_TAG: edge
sources:
  - https://git.sr.ht/~mlb/linkhut
tasks:
  - setup: |
      sudo rc-service docker start
      sudo addgroup $USER docker
  - build: |
      cd linkhut
      docker build -f contrib/docker/Dockerfile -t ${DOCKER_REGISTRY}/${DOCKER_REPOSITORY}:${DOCKER_TAG} .
      docker tag ${DOCKER_REGISTRY}/${DOCKER_REPOSITORY}:${DOCKER_TAG} ${DOCKER_REGISTRY}/${DOCKER_REPOSITORY}:$(git rev-parse --short HEAD)
  - push: |
      cd linkhut
      # Load Docker registry secrets
      set +x -a
      source ~/docker-hub.env
      # Login to Docker registry using secrets
      echo $DOCKER_PASSWORD | docker login ${DOCKER_REGISTRY} -u $DOCKER_USERNAME --password-stdin
      set -x +a
      # Push latest tag
      docker push ${DOCKER_REGISTRY}/${DOCKER_REPOSITORY}:${DOCKER_TAG}
      # Push git commit tag
      docker push ${DOCKER_REGISTRY}/${DOCKER_REPOSITORY}:$(git rev-parse --short HEAD)
  - cleanup: |
      docker system prune -f
