image: alpine/edge
packages:
  - docker
  - docker-cli-compose
secrets:
  -  dafdc7fa-451e-44cb-aa67-339ae7ca2e87 # docker registry credentials
environment:
  DOCKER_REGISTRY: docker.io
  DOCKER_IMAGE: matiaslb/linkhut
  DOCKER_TAG: edge
sources:
  - https://git.sr.ht/~mlb/linkhut
tasks:
  - setup: |
      sudo rc-service docker start
      sudo addgroup $USER docker
  - login: |
      # Load Docker registry secrets
      set +x -a
      source ~/docker-hub.env
      # Login to Docker registry using secrets
      echo $DOCKER_PASSWORD | docker login ${DOCKER_REGISTRY} -u $DOCKER_USERNAME --password-stdin
      set -x +a
  - build: |
      cd linkhut
      docker buildx create --use
      docker buildx build --push --platform linux/amd64,linux/arm64 -f contrib/docker/Dockerfile -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
